# –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ LearnFlow AI

## –û–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–π —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ LearnFlow AI, –≤–∫–ª—é—á–∞—è –∑–∞–≥—Ä—É–∑–∫—É, —Ö—Ä–∞–Ω–µ–Ω–∏–µ, –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LangGraph workflow.

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. –ï–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ `process_step()` –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ –±–µ–∑)
- –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ `process_step_with_images()`
- –ü–µ—Ä–µ–¥–∞—á–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `image_paths: List[str] = None`

### 2. –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ü–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ —Å–µ–º–∞–Ω—Ç–∏–∫—É –ø–æ–ª–µ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è:
  - `image_paths=None` –∏–ª–∏ `[]` ‚Üí –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
  - `image_paths=[...]` ‚Üí –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã
  - `recognized_notes=None` ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
  - `recognized_notes=""` ‚Üí —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ/–ø—Ä–æ–ø—É—â–µ–Ω–æ, —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π
  - `recognized_notes="—Ç–µ–∫—Å—Ç"` ‚Üí —É—Å–ø–µ—à–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
  - `recognition_attempts` ‚Üí —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–ø—Ä–æ—Å–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Command API
- –ü—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ workflow —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º `Command(resume=..., update={...})`
- –ü–æ–ª–µ `update` –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –£–∑–µ–ª –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è —Å–∞–º –≤ —Å–µ–±—è —á–µ—Ä–µ–∑ `Command(goto="recognition_handwritten")` –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ HITL
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç:
  - –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
  - –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
- –£–∑–µ–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã –ø–æ—Å–ª–µ interrupt

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### GraphManager

```python
class GraphManager:
    async def process_step(
        self, 
        thread_id: str, 
        query: str, 
        image_paths: List[str] = None
    ) -> Dict[str, Any]:
        """
        –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —à–∞–≥–æ–≤ workflow.
        
        Args:
            thread_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ—Ç–æ–∫–∞
            query: –¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞
            image_paths: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å thread_id –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        """
        state = await self._get_state(thread_id)
        
        if not state.values:
            # –ù–æ–≤—ã–π workflow - —Å–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            input_state = ExamState(
                exam_question=query,
                image_paths=image_paths or []
            )
            session_id = self.create_new_session(thread_id)
        else:
            # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ workflow
            if image_paths:
                # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Command.update
                input_state = Command(
                    resume=query,
                    update={"image_paths": image_paths}
                )
            else:
                # –û–±—ã—á–Ω–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                input_state = Command(resume=query)
            
            session_id = self.get_session_id(thread_id) or self.create_new_session(thread_id)
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ workflow
        cfg = {
            "configurable": {"thread_id": thread_id},
            "callbacks": [self.langfuse_handler],
            "metadata": {
                "langfuse_session_id": session_id,
                "langfuse_user_id": thread_id
            },
        }
        
        # ... –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
```

### RecognitionNode

```python
class RecognitionNode(BaseWorkflowNode):
    """
    –£–∑–µ–ª —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä—É–∫–æ–ø–∏—Å–Ω—ã—Ö –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
    - –ó–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ workflow
    - –ü–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    - –ü—Ä–æ–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ø–æ –∂–µ–ª–∞–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    
    async def __call__(self, state: ExamState, config) -> Command:
        thread_id = config["configurable"]["thread_id"]
        logger.info(f"RecognitionNode started for thread {thread_id}")
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å
        if state.image_paths:
            logger.info(f"Found {len(state.image_paths)} images, starting recognition")
            
            recognized_text = await self._process_images(state.image_paths)
            
            if recognized_text:
                logger.info(f"Recognition successful, proceeding to synthesis")
                return Command(
                    goto="synthesis_material",
                    update={"recognized_notes": recognized_text}
                )
            else:
                logger.warning(f"Recognition failed, skipping synthesis")
                return Command(
                    goto="generating_questions",
                    update={"synthesized_material": state.generated_material}
                )
        
        # –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        logger.info(f"No images found, requesting from user (attempt {state.recognition_attempts + 1})")
        
        interrupt_json = {
            "message": "üì∏ –î–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤.\n\n"
                      "–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π:\n"
                      "‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤–∞—à–∏—Ö –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤\n"
                      "‚Ä¢ –ù–∞–ø–∏—à–∏—Ç–µ '–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å' –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"
        }
        
        user_response = interrupt(interrupt_json)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if '–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å' in user_response.lower() or state.recognition_attempts >= 3:
            if state.recognition_attempts >= 3:
                logger.info("Max attempts reached, skipping recognition")
            else:
                logger.info("User chose to skip recognition")
                
            return Command(
                goto="generating_questions",
                update={"synthesized_material": state.generated_material}
            )
        else:
            logger.info("User response received, retrying recognition node")
            return Command(
                goto="recognition_handwritten",
                update={"recognition_attempts": state.recognition_attempts + 1}
            )
```

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°—Ç–∞—Ä—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:**

1. **Telegram Bot**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ + —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
2. **Bot –æ–±—Ä–∞–±–æ—Ç–∫–∞**:
   ```python
   # –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º —Ñ–æ—Ç–æ –≤ pending_media
   pending_media[user_id] = {
       "photos": [photo_data1, photo_data2],
       "text": "–û–±—ä—è—Å–Ω–∏—Ç–µ RSA —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ"
   }
   ```

3. **API –≤—ã–∑–æ–≤**:
   ```python
   # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   image_paths = await upload_images(thread_id, photos)
   # –ó–∞–ø—É—Å–∫ workflow
   result = await graph_manager.process_step(
       thread_id, 
       "–û–±—ä—è—Å–Ω–∏—Ç–µ RSA —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ",
       image_paths
   )
   ```

4. **GraphManager**:
   - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å `image_paths`
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç workflow

5. **RecognitionNode**:
   - –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç `state.image_paths` 
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ `synthesis_material`
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ `generating_questions` (–ø—Ä–æ–ø—É—Å–∫–∞—è —Å–∏–Ω—Ç–µ–∑)

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ workflow —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:**

1. **–ù–∞—á–∞–ª–æ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**:
   ```python
   # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–û–±—ä—è—Å–Ω–∏—Ç–µ RSA —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ"
   result = await graph_manager.process_step(thread_id, query, None)
   ```

2. **RecognitionNode - –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤**:
   - `state.image_paths = None`
   - `state.recognition_attempts = 0`
   - –î–µ–ª–∞–µ—Ç `interrupt` —Å –∑–∞–ø—Ä–æ—Å–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   - Workflow –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏ –∂–¥–µ—Ç –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**:
   ```python
   # Bot –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   image_paths = await upload_images(thread_id, photos)
   # –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç workflow
   result = await graph_manager.process_step(
       thread_id,
       "–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å", 
       image_paths
   )
   ```

4. **GraphManager - –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ**:
   ```python
   # –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   # –°–æ–∑–¥–∞–µ—Ç Command —Å update –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   input_state = Command(
       resume="–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
       update={"image_paths": image_paths}
   )
   ```

5. **RecognitionNode - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ —Å –Ω–∞—á–∞–ª–∞**:
   - `state.image_paths = [path1, path2]` (–æ–±–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ Command.update)
   - –°—Ä–∞–∑—É –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø–µ—Ä–≤–æ–µ —É—Å–ª–æ–≤–∏–µ `if state.image_paths:`
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ `synthesis_material` —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º `recognized_notes`
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ `generating_questions`, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è `synthesized_material = generated_material`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£—Å–ø–µ—à–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–æ–ø—É—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:**

1. **–ü–æ—Å–ª–µ interrupt –≤ RecognitionNode**:
   - Bot: "–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ '–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å'"
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"

2. **–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**:
   ```python
   result = await graph_manager.process_step(
       thread_id,
       "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å",
       None
   )
   ```

3. **RecognitionNode - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ø–æ—Å–ª–µ interrupt**:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `state.image_paths` - –≤—Å–µ –µ—â–µ –ø—É—Å—Ç–æ
   - –°–Ω–æ–≤–∞ –¥–µ–ª–∞–µ—Ç `interrupt` –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–ø—É—Å–∫:
   ```python
   if "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å" in user_response.lower():
       return Command(
           goto="generating_questions",
           update={"synthesized_material": state.generated_material}
       )
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: Workflow –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤ ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:**

1. **RecognitionNode –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**:
   - –ú–µ—Ç–æ–¥ `_process_images()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (–æ—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è)

2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –±–µ–∑ —Å–∏–Ω—Ç–µ–∑–∞**:
   ```python
   if recognized_text:
       # –£—Å–ø–µ—Ö - –∏–¥–µ–º –∫ —Å–∏–Ω—Ç–µ–∑—É
   else:
       # –û—à–∏–±–∫–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ç–µ–∑
       return Command(
           goto="generating_questions",
           update={"synthesized_material": state.generated_material}
       )
   ```

3. **Workflow –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è**:
   - –°–∏–Ω—Ç–µ–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω
   - `synthesized_material` –ø—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ—Ç `generated_material`
   - –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –æ—à–∏–±–∫–∞–º —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä–∞ ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è

**–°–∏—Ç—É–∞—Ü–∏—è**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–û–±—Ä–∞–±–æ—Ç–∫–∞**:
```python
if '–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å' in user_response.lower() or state.recognition_attempts >= 3:
    if state.recognition_attempts >= 3:
        logger.info("Max attempts reached, skipping recognition")
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–ø—É—Å–∫ –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫
    return Command(
        goto="generating_questions",
        update={"synthesized_material": state.generated_material}
    )
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ ‚úÖ

## –•—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤**:
```
/tmp/learnflow/
‚îî‚îÄ‚îÄ {thread_id}/
    ‚îî‚îÄ‚îÄ images/
        ‚îú‚îÄ‚îÄ image_00_{hash}.png
        ‚îú‚îÄ‚îÄ image_01_{hash}.png
        ‚îî‚îÄ‚îÄ image_02_{hash}.png
```

**–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª**:
1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–µ—Ä–µ–∑ `/upload-images/{thread_id}`
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ `RecognitionNode`
3. –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `delete_thread(thread_id)`

### API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

| –≠–Ω–¥–ø–æ–∏–Ω—Ç | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|
| `/upload-images/{thread_id}` | POST | –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ 10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π |
| `/process` | POST | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `/state/{thread_id}` | GET | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è |
| `/thread/{thread_id}` | DELETE | –£–¥–∞–ª–µ–Ω–∏–µ thread –∏ —Ñ–∞–π–ª–æ–≤ |

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. State (ExamState)

**–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ**:
```python
class ExamState(TypedDict):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    recognition_attempts: int  # –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
```

### 2. GraphManager

**–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å**:
```python
async def process_step(self, thread_id: str, query: str, image_paths: List[str] = None):
    state = await self._get_state(thread_id)
    
    if not state.values:
        # –ù–æ–≤—ã–π workflow
        input_state = ExamState(
            exam_question=query,
            image_paths=image_paths or []
        )
    else:
        # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ workflow
        if image_paths:
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            input_state = Command(
                resume=query,
                update={"image_paths": image_paths}
            )
        else:
            # –û–±—ã—á–Ω–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
            input_state = Command(resume=query)
```

### 3. API (main.py)

**–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å**:
```python
class ProcessRequest(BaseModel):
    thread_id: Optional[str] = None
    message: str
    image_paths: Optional[List[str]] = None  # –î–æ–±–∞–≤–∏—Ç—å
```

### 4. Telegram Bot

**–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å**:
```python
async def _process_message(
    self, 
    thread_id: str, 
    message_text: str,
    image_paths: List[str] = None  # –î–æ–±–∞–≤–∏—Ç—å
) -> Dict[str, Any]:
    async with session.post(
        f"{self.api_base_url}/process",
        json={
            "message": message_text,
            "thread_id": thread_id,
            "image_paths": image_paths  # –î–æ–±–∞–≤–∏—Ç—å
        }
    )
```

### 5. RecognitionNode

**–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É**:
- –ú–µ—Ç–æ–¥ `_process_images()` —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π retry (3 –ø–æ–ø—ã—Ç–∫–∏)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `recognition_attempts` –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–∏–Ω—Ç–µ–∑
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Å–µ–±—è —á–µ—Ä–µ–∑ `Command(goto="recognition_handwritten")` –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

1. **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è API** - –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ –∏ –ª–æ–≥–∏–∫–∏
3. **–ì–∏–±–∫–æ—Å—Ç—å** - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏
4. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤
5. **–ß–∏—Å—Ç–æ—Ç–∞ –∫–æ–¥–∞** - —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∞–º–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å–µ–±—è
6. **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –æ—à–∏–±–∫–∞–º** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ —Å–±–æ—è—Ö
7. **–£–ª—É—á—à–µ–Ω–Ω—ã–π UX** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ—Ü–µ—Å—Å–æ–º

## –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 10MB –Ω–∞ —Ñ–∞–π–ª
2. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ** - –º–∞–∫—Å–∏–º—É–º 10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
3. **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** - —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ thread
4. **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –Ω–µ–ª—å–∑—è –∑–∞–º–µ–Ω–∏—Ç—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã

1. **–°—Ç–∞—Ä—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —Ñ–ª–æ—É
2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ** - –ø—Ä–æ–≤–µ—Ä–∫–∞ Command.update
3. **–ü—Ä–æ–ø—É—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
4. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
5. **–û—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ fallback –ª–æ–≥–∏–∫–∏
6. **–ë–æ–ª—å—à–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
7. **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

- –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ ~30% –∑–∞ —Å—á–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –£–ª—É—á—à–µ–Ω–∏–µ UX - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–≥–¥–∞ —É–¥–æ–±–Ω–æ
- –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∞–≥–æ–≤ –∑–∞ —Å—á–µ—Ç —É–ø—Ä–æ—â–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ GraphManager
2. –û–±–Ω–æ–≤–∏—Ç—å API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Telegram Bot
4. –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
5. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è