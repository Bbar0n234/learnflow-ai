# IP-03: Telegram Bot UI для управления промптами

## Смысл и цель задачи

Создать пользовательский интерфейс в Telegram боте для управления персонализацией промптов через inline-кнопки и интерактивные меню. Интерфейс позволит пользователям быстро выбирать профили для разных предметов и стилей, а также гибко настраивать отдельные плейсхолдеры. Основное ожидание - интуитивный UX с минимальным количеством кликов для основных сценариев использования.

## Архитектура решения

**Модули для создания/модификации:**
- `bot/handlers/prompt_config.py` - новый обработчик команд для управления промптами
- `bot/keyboards/prompt_keyboards.py` - клавиатуры и inline-кнопки для настройки
- `bot/services/prompt_config_client.py` - клиент для работы с Prompt Config Service
- `bot/states/prompt_config.py` - FSM состояния для многошаговой настройки
- `bot/models/prompt_config.py` - Pydantic модели для работы с данными промптов

**Размещение файлов:**
```
bot/
├── handlers/
│   ├── prompt_config.py       # Основной обработчик команд /configure
│   └── hitl_settings.py       # Существующий (для примера структуры)
├── keyboards/
│   ├── prompt_keyboards.py    # Генерация inline клавиатур
│   └── hitl_keyboards.py      # Существующий (для примера)
├── services/
│   ├── prompt_config_client.py # HTTP клиент к Prompt Config Service
│   └── api_client.py          # Существующий клиент LearnFlow
├── states/
│   └── prompt_config.py       # FSM состояния для настройки
└── models/
    └── prompt_config.py       # Модели данных промптов
```

## Полный flow работы функционала

1. **Команда /configure - главное меню:**
   - Пользователь вводит `/configure`
   - Бот запрашивает текущие настройки пользователя из Prompt Config Service
   - Отображается меню с тремя секциями: быстрые профили, текущие настройки, детальная настройка
   - Пользователь видит активный профиль и может выбрать действие

2. **Выбор профиля (быстрая настройка):**
   - Пользователь нажимает "📚 Выбрать профиль"
   - Отображается список категорий: "Стили изложения" и "Предметные области"
   - При выборе категории показываются доступные профили с описаниями
   - При выборе профиля - применение всех его настроек одним действием
   - Подтверждение успешного применения и возврат в главное меню

3. **Индивидуальная настройка плейсхолдеров:**
   - Пользователь нажимает "⚙️ Детальная настройка"
   - Отображается полный список всех плейсхолдеров с текущими значениями
   - При выборе плейсхолдера - список доступных значений
   - При выборе значения - сохранение и возврат к списку плейсхолдеров

4. **Просмотр текущих настроек:**
   - Пользователь нажимает "📋 Мои настройки"
   - Отображается полный список настроенных плейсхолдеров
   - Кнопка "Изменить" рядом с каждым параметром

5. **Сброс к дефолтным настройкам:**
   - Команда `/reset_prompts` или кнопка в меню
   - Запрос подтверждения действия
   - При подтверждении - сброс всех настроек к дефолтным
   - Уведомление об успешном сбросе

## API и интерфейсы

**PromptConfigClient (bot/services/prompt_config_client.py):**
- `get_profiles()` - получить список всех профилей
  - Параметры: category (optional)
  - Возвращает: List[Profile] с информацией о профилях
  
- `get_user_placeholders(user_id)` - получить настройки пользователя
  - Параметры: user_id (int)
  - Возвращает: Dict[str, PlaceholderValue] текущие настройки
  
- `apply_profile(user_id, profile_id)` - применить профиль
  - Параметры: user_id (int), profile_id (str)
  - Возвращает: UserSettings обновленные настройки
  
- `set_placeholder(user_id, placeholder_id, value_id)` - изменить плейсхолдер
  - Параметры: user_id (int), placeholder_id (str), value_id (str)
  - Возвращает: PlaceholderSetting обновленная настройка
  
- `get_placeholder_values(placeholder_id)` - получить доступные значения
  - Параметры: placeholder_id (str)
  - Возвращает: List[PlaceholderValue] список значений

**Обработчики команд (bot/handlers/prompt_config.py):**
- `cmd_configure` - главное меню настройки промптов
- `callback_select_profile` - выбор профиля из списка
- `callback_select_placeholder` - выбор плейсхолдера для изменения
- `callback_set_value` - установка значения плейсхолдера
- `cmd_reset_prompts` - сброс к дефолтным настройкам
- `callback_view_settings` - просмотр текущих настроек

**FSM состояния (bot/states/prompt_config.py):**
- `PromptConfigStates.main_menu` - главное меню
- `PromptConfigStates.selecting_profile` - выбор профиля
- `PromptConfigStates.selecting_placeholder` - выбор плейсхолдера
- `PromptConfigStates.selecting_value` - выбор значения

## Взаимодействие компонентов

```
User Input (/configure) -> Command Handler -> PromptConfigClient -> Prompt Config Service
                |                  |                   |                    |
                v                  v                   v                    v
        Parse command      Build keyboard      HTTP GET/POST         Return data
                |          with current data    to API                     |
                v                  |                   |                    |
        Check FSM state           v                   v                    |
                |          Generate inline      Handle response            |
                v          buttons/menus              |                    |
        Send message              |                   v                    |
        with keyboard  <----------+------------- Format data <-------------+
```

**Навигация по меню:**
```
/configure (главное меню)
    ├── 📚 Выбрать профиль
    │   ├── Стили изложения
    │   │   ├── Технический эксперт
    │   │   ├── Образовательный путь
    │   │   └── Быстрая справка
    │   └── Предметные области
    │       ├── Информационная безопасность
    │       ├── Машинное обучение
    │       └── [другие предметы]
    ├── ⚙️ Детальная настройка
    │   ├── Роль эксперта
    │   ├── Язык
    │   ├── Целевая аудитория
    │   ├── Стиль изложения
    │   ├── Глубина объяснения
    │   ├── Тип материала
    │   ├── Формат вопросов
    │   └── [другие плейсхолдеры]
    ├── 📋 Мои настройки (просмотр)
    └── 🔄 Сброс к дефолтным
```

## Порядок реализации

1. **Создание моделей данных и клиента (bot/models/, bot/services/):**
   - Pydantic модели для Profile, Placeholder, PlaceholderValue
   - HTTP клиент PromptConfigClient с методами API
   - Обработка ошибок и retry логика

2. **FSM состояния для навигации (bot/states/):**
   - Определение состояний для многошаговой настройки
   - Сохранение промежуточных данных в FSM storage
   - Навигация "назад" через состояния

3. **Генерация клавиатур (bot/keyboards/):**
   - Главное меню с основными действиями
   - Динамические клавиатуры для профилей
   - Пагинация для длинных списков значений
   - Кнопки "Назад" и "Отмена" для навигации

4. **Обработчики команд (bot/handlers/):**
   - Команда /configure с проверкой авторизации
   - Callback handlers для всех inline кнопок
   - Валидация входных данных
   - Форматирование ответов с emoji

5. **Интеграция с основным ботом:**
   - Регистрация router в main.py
   - Добавление команд в /help
   - Логирование действий пользователя

6. **Кэширование для оптимизации:**
   - In-memory кэш списка профилей (TTL 5 минут)
   - Кэш значений плейсхолдеров (TTL 10 минут)
   - Инвалидация при изменениях

## Критичные граничные случаи

**Недоступность Prompt Config Service:**
- Показать сообщение "Сервис временно недоступен"
- Предложить попробовать позже
- Логирование ошибки для мониторинга

**Длинные списки значений (>20 элементов):**
- Реализовать пагинацию по 10 элементов
- Кнопки "← Назад" и "Вперед →"
- Индикатор текущей страницы

**Конкурентные изменения настроек:**
- Использовать user_id как ключ блокировки
- Atomic операции на уровне сервиса
- Показывать актуальное состояние после изменения

**Некорректные callback_data:**
- Валидация формата данных из callback
- Graceful handling неизвестных значений
- Возврат в главное меню при ошибке

**Превышение лимитов Telegram API:**
- Ограничение длины сообщений (4096 символов)
- Разбивка длинных списков на несколько сообщений
- Throttling для избежания rate limits