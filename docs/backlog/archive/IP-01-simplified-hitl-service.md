# Implementation Plan: Simplified HITL Service Architecture

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

1. **HITLManager Service** (`learnflow/services/hitl_manager.py`)
   - –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π HITL
   - –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ per-user (–ø–æ thread_id) –≤ –ø–∞–º—è—Ç–∏
   - –ü—Ä–æ—Å—Ç–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –º–µ–∂–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏ –≥—Ä–∞—Ñ–æ–≤

2. **HITLConfig Model** (`learnflow/models/hitl_config.py`)
   - –ü—Ä–æ—Å—Ç–∞—è Pydantic –º–æ–¥–µ–ª—å —Å –±—É–ª–µ–≤—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏
   - –§–ª–∞–≥–∏ —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏–º–µ–Ω–∞–º —É–∑–ª–æ–≤
   - –ë–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤

3. **Node Adaptations**
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–∑–ª–∞—Ö
   - –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ HITLManager –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º interrupt()

4. **API Extensions** (`learnflow/api/main.py`)
   - REST endpoints –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
   - Get/Set –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è thread-specific –Ω–∞—Å—Ç—Ä–æ–µ–∫
   - Bulk update –¥–ª—è –≤—Å–µ—Ö —Ñ–ª–∞–≥–æ–≤

5. **Telegram Bot Integration** (`bot/handlers/hitl_settings.py`)
   - –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è HITL –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
   - –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –º–µ–Ω—é
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FastAPI —á–µ—Ä–µ–∑ HTTP-–∫–ª–∏–µ–Ω—Ç

## API –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

### 1. HITLConfig Model

```python
class HITLConfig(BaseModel):
    """–ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è HITL —Å —Ñ–ª–∞–≥–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞"""
    
    # –§–ª–∞–≥–∏ –¥–ª—è —É–∑–ª–æ–≤ (—Ç–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–º–µ–Ω–∞–º –≤ graph.py)
    edit_material: bool = Field(
        default=True,
        description="Enable HITL for material editing node"
    )
    
    generating_questions: bool = Field(
        default=True,
        description="Enable HITL for question generation node"
    )
    
    # Helper –º–µ—Ç–æ–¥—ã
    def is_enabled_for_node(self, node_name: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∫–ª—é—á–µ–Ω –ª–∏ HITL –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞"""
        
    @classmethod
    def all_enabled(cls) -> "HITLConfig":
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–æ –≤—Å–µ–º–∏ –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏"""
        
    @classmethod
    def all_disabled(cls) -> "HITLConfig":
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–æ –≤—Å–µ–º–∏ –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏"""
```

### 2. HITLManager Service

```python
class HITLManager:
    """–°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è HITL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π"""
        self._configs: Dict[str, HITLConfig] = {}  # thread_id -> config
        self._default_config: HITLConfig = HITLConfig()
    
    def is_enabled(self, node_name: str, thread_id: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∫–ª—é—á–µ–Ω –ª–∏ HITL –¥–ª—è —É–∑–ª–∞ –∏ –ø–æ—Ç–æ–∫–∞.
        
        Args:
            node_name: –ò–º—è —É–∑–ª–∞
            thread_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ Telegram)
            
        Returns:
            True –µ—Å–ª–∏ HITL –≤–∫–ª—é—á–µ–Ω, False –∏–Ω–∞—á–µ
        """
        
    def get_config(self, thread_id: str) -> HITLConfig:
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
    def set_config(self, thread_id: str, config: HITLConfig) -> None:
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
    def update_node_setting(self, thread_id: str, node_name: str, enabled: bool) -> HITLConfig:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞"""
        
    def reset_config(self, thread_id: str) -> None:
        """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        
```

### 3. Singleton Instance

```python
# –í learnflow/services/hitl_manager.py
_hitl_manager_instance = None

def get_hitl_manager() -> HITLManager:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç singleton instance HITLManager"""
    global _hitl_manager_instance
    if _hitl_manager_instance is None:
        _hitl_manager_instance = HITLManager()
    return _hitl_manager_instance
```

### 4. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —É–∑–ª–æ–≤


### 5. API Endpoints

```python
# GET /api/hitl/{thread_id}
async def get_hitl_config(thread_id: str) -> HITLConfig:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é HITL –¥–ª—è –ø–æ—Ç–æ–∫–∞"""
    
# PUT /api/hitl/{thread_id}
async def set_hitl_config(thread_id: str, config: HITLConfig) -> HITLConfig:
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é HITL –¥–ª—è –ø–æ—Ç–æ–∫–∞"""
    
# PATCH /api/hitl/{thread_id}/node/{node_name}
async def update_node_hitl(thread_id: str, node_name: str, enabled: bool) -> HITLConfig:
    """–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É HITL –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞"""
    
# POST /api/hitl/{thread_id}/reset
async def reset_hitl_config(thread_id: str) -> HITLConfig:
    """–°–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
    
# POST /api/hitl/{thread_id}/bulk
async def bulk_update_hitl(thread_id: str, enable_all: bool) -> HITLConfig:
    """–í–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å HITL –¥–ª—è –≤—Å–µ—Ö —É–∑–ª–æ–≤"""
```

### 6. Telegram Bot Integration

#### –ö–æ–º–∞–Ω–¥—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

```python
# bot/handlers/hitl_settings.py

@router.message(Command("hitl"))
async def show_hitl_menu(message: Message, state: FSMContext):
    """
    –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ HITL
    
    /hitl - –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    """

@router.callback_query(F.data == "hitl_toggle_all")
async def toggle_all_hitl(callback: CallbackQuery):
    """–ë—ã—Å—Ç—Ä–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö HITL"""

@router.callback_query(F.data.startswith("hitl_toggle_"))
async def toggle_node_hitl(callback: CallbackQuery):
    """–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ HITL –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞"""

@router.callback_query(F.data == "hitl_preset_autonomous")
async def set_autonomous_preset(callback: CallbackQuery):
    """Preset: –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º (–≤—Å–µ HITL –≤—ã–∫–ª—é—á–µ–Ω—ã)"""

@router.callback_query(F.data == "hitl_preset_guided")
async def set_guided_preset(callback: CallbackQuery):
    """Preset: –£–ø—Ä–∞–≤–ª—è–µ–º—ã–π —Ä–µ–∂–∏–º (–≤—Å–µ HITL –≤–∫–ª—é—á–µ–Ω—ã)"""
```

#### API Client –¥–ª—è –±–æ—Ç–∞

```python
# bot/services/api_client.py

class LearnFlowAPIClient:
    """HTTP-–∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å FastAPI —Å–µ—Ä–≤–∏—Å–æ–º"""
    
    def __init__(self, base_url: str = "http://localhost:8000"):
        self.base_url = base_url
        self.session = aiohttp.ClientSession()
    
    async def get_hitl_config(self, user_id: int) -> HITLConfig:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é HITL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
    async def update_hitl_config(self, user_id: int, config: HITLConfig) -> HITLConfig:
        """–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é HITL"""
        
    async def toggle_node_hitl(self, user_id: int, node_name: str) -> HITLConfig:
        """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å HITL –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞"""
        
    async def bulk_update_hitl(self, user_id: int, enable_all: bool) -> HITLConfig:
        """–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å HITL –¥–ª—è –≤—Å–µ—Ö —É–∑–ª–æ–≤"""
```

#### Keyboard –∏ UI Components

```python
# bot/keyboards/hitl_keyboards.py

def build_hitl_settings_keyboard(config: HITLConfig) -> InlineKeyboardMarkup:
    """
    –°—Ç—Ä–æ–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ HITL —Å —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
    
    Layout:
    [üéØ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ‚úÖ] [üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤: ‚úÖ]
    [üöÄ –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º] [üéõÔ∏è –£–ø—Ä–∞–≤–ª—è–µ–º—ã–π —Ä–µ–∂–∏–º]
    [üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤—Å–µ] [‚Ü©Ô∏è –ù–∞–∑–∞–¥]
    """

def build_confirmation_keyboard(action: str) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π"""

def build_preset_selection_keyboard() -> InlineKeyboardMarkup:
    """–ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤"""
```

#### User Experience Flow

1. **–í—Ö–æ–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
   ```
   /hitl ‚Üí –ü–æ–∫–∞–∑ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ + –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   ```

2. **–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**
   ```
   "üöÄ –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ä–µ–∂–∏–º" ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –í—Å–µ HITL OFF
   "üéõÔ∏è –£–ø—Ä–∞–≤–ª—è–µ–º—ã–π —Ä–µ–∂–∏–º" ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí –í—Å–µ HITL ON
   "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤—Å–µ" ‚Üí –ò–Ω–≤–µ—Ä—Å–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   ```

3. **–¢–æ—á–µ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:**
   ```
   –ö–Ω–æ–ø–∫–∞ —É–∑–ª–∞ ‚Üí –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ ‚Üí –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
   ```

4. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:**
   ```
   –ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Üí Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
   –û—à–∏–±–∫–∏ API ‚Üí –ü–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   ```

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ—Ç–æ–∫–æ–º

```python
# bot/handlers/main_flow.py

async def process_exam_request(message: Message):
    """
    –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —ç–∫–∑–∞–º–µ–Ω–∞
    
    –ò–∑–º–µ–Ω–µ–Ω–∏—è:
    - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ HITL –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
    - –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
    """
    
    user_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é HITL
    config = await api_client.get_hitl_config(user_id)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–µ–∂–∏–º –æ–±—Ä–∞–±–æ—Ç–∫–∏
    await message.answer(
        f"üìã **–†–µ–∂–∏–º –æ–±—Ä–∞–±–æ—Ç–∫–∏:**\n"
        f"‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {'‚úÖ –í–∫–ª—é—á–µ–Ω–æ' if config.edit_material else '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ'}\n"
        f"‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤: {'‚úÖ –í–∫–ª—é—á–µ–Ω–∞' if config.generating_questions else '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–∞'}\n\n"
        f"–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: /hitl",
        reply_markup=build_quick_settings_keyboard()
    )
```

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –ü–æ—Ç–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   - HITLManager —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è thread_id
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –∏ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è

2. **–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É–∑–ª–∞:**
   - –£–∑–µ–ª –ø–æ–ª—É—á–∞–µ—Ç thread_id –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (Telegram user ID)
   - –£–∑–µ–ª –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç HITLManager.is_enabled(node_name, thread_id)
   - –ù–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã

### –ü–æ—Ç–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
   ```
   Client ‚Üí API Endpoint ‚Üí HITLManager ‚Üí Update in-memory config
   ```

2. **–£–∑–µ–ª –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
   ```
   Node ‚Üí get_hitl_manager() ‚Üí is_enabled(node_name, thread_id) ‚Üí bool
   ```

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞:**
   ```
   Telegram User ‚Üí /hitl command ‚Üí Bot Handler ‚Üí HTTP Request ‚Üí FastAPI ‚Üí HITLManager
   ```

### –ü–æ—Ç–æ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Telegram Bot ‚Üî FastAPI

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
   ```
   Bot Handler ‚Üí GET /api/hitl/{user_id} ‚Üí HITLManager.get_config() ‚Üí HITLConfig
   ```

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
   ```
   User Action ‚Üí Bot Callback ‚Üí PATCH /api/hitl/{user_id}/node/{node_name} ‚Üí Updated Config
   ```

3. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:**
   ```
   Updated Config ‚Üí build_hitl_settings_keyboard() ‚Üí Telegram InlineKeyboard ‚Üí User
   ```


### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —É–∑–ª–∞–º–∏

1. **EditMaterialNode:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `hitl_manager.is_enabled("edit_material", thread_id)`
   - –ü—Ä–∏ HITL off: –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–µ—Ä—Å–∏—é –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ rollback

2. **QuestionGenerationNode:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `hitl_manager.is_enabled("generating_questions", thread_id)`
   - –ü—Ä–∏ HITL off: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –∫–∞—á–µ—Å—Ç–≤–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç structured output –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

## Edge Cases –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### 1. Thread ID Management
- **–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ thread_id –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
- **–†–µ—à–µ–Ω–∏–µ:** Fallback –Ω–∞ "default" thread_id
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è user_id –≤ ExamState

### 2. –ü–∞–º—è—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–†–µ—à–µ–Ω–∏–µ:** 
  - –ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏ –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏
  - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Redis –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞
- **–ü—Ä–æ–±–ª–µ–º–∞:** –£–∑–ª—ã –æ–∂–∏–¥–∞—é—Ç HITL –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–Ω—ã–º
- **–†–µ—à–µ–Ω–∏–µ:**
  - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ —Ñ–ª–∞–≥–∏ = True
  - –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ feature flag
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 4. –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏
- **–†–µ—à–µ–Ω–∏–µ:**
  - –í –ø–∞–º—è—Ç–∏ - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
  - –î–ª—è prod - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Redis –∏–ª–∏ –ë–î
  - API –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

### 5. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- **–ü—Ä–æ–±–ª–µ–º–∞:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –Ω–µ –∑–Ω–∞–µ—Ç –æ HITLManager
- **–†–µ—à–µ–Ω–∏–µ:**
  - HITLManager –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç True
  - Feature flag –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
  - –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —É–∑–ª–æ–≤

### 6. –û—Ç–ª–∞–¥–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ—à–µ–Ω–∏–π HITL
- **–†–µ—à–µ–Ω–∏–µ:**
  - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
  - –ú–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è HITL/non-HITL —Ä–µ–∂–∏–º–æ–≤
  - Debug endpoint –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π