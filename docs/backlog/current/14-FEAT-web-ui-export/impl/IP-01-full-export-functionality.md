# Implementation Plan: Full Export Functionality for Web UI

## Смысл и цель задачи

Добавить полноценную функциональность экспорта в Web UI, позволяющую пользователям экспортировать как отдельные документы, так и пакеты документов в форматах Markdown и PDF. Текущая реализация имеет только базовый экспорт в FileExplorer, а компоненты ExportDialog и ExportButton минимально интегрированы. Задача обеспечит пользователям удобный интерфейс для экспорта их учебных материалов.

## Архитектура решения

Решение будет использовать существующие компоненты и методы API:
- **ExportDialog** (`web-ui/src/components/export/ExportDialog.tsx`) - основной UI для выбора параметров экспорта
- **ExportButton** (`web-ui/src/components/export/ExportButton.tsx`) - кнопка для запуска диалога экспорта
- **ApiClient** - уже имеет все необходимые методы для экспорта
- **App.tsx** - главный компонент, где будет управляться состояние экспорта
- **DocumentHeader** - добавим кнопку экспорта для отдельных документов
- **FileExplorer** - улучшим существующую интеграцию

Новые хуки для управления экспортом:
- **useExport** (`web-ui/src/hooks/useExport.ts`) - централизованная логика экспорта

## Полный flow работы функционала

1. **Инициация экспорта**:
   - Пользователь нажимает кнопку экспорта в FileExplorer (для сессии) или DocumentHeader (для документа)
   - Открывается ExportDialog с предзаполненными опциями

2. **Выбор параметров**:
   - Режим экспорта: single (один документ) или package (пакет)
   - Для single: выбор конкретного документа из доступных
   - Для package: выбор типа пакета (final или all)
   - Выбор формата: markdown или pdf

3. **Процесс экспорта**:
   - При нажатии "Экспортировать" вызывается соответствующий метод ApiClient
   - Показывается состояние загрузки
   - Получаемый Blob автоматически скачивается через downloadBlob

4. **Завершение**:
   - Диалог закрывается
   - Файл сохраняется на устройство пользователя

## API и интерфейсы

### useExport Hook
- **exportSingleDocument** - экспорт одного документа
  - Параметры: threadId, sessionId, documentName, format
  - Возвращает: Promise<void>
  
- **exportPackage** - экспорт пакета документов
  - Параметры: threadId, sessionId, packageType, format
  - Возвращает: Promise<void>

- **getAvailableDocuments** - получение списка доступных документов для экспорта
  - Параметры: sessionFiles
  - Возвращает: string[] (имена документов)

### Состояние экспорта в App.tsx
- **isExportDialogOpen**: boolean - открыт ли диалог экспорта
- **exportContext**: объект с threadId, sessionId, availableDocuments
- **exportLoading**: boolean - идет ли процесс экспорта

## Взаимодействие компонентов

```
FileExplorer/DocumentHeader -> открывает ExportDialog
                             -> передает контекст (threadId, sessionId, documents)
                             
ExportDialog -> использует useExport hook
             -> вызывает exportSingleDocument или exportPackage
             
useExport -> вызывает ApiClient методы
          -> обрабатывает ошибки
          -> управляет состоянием загрузки
          
ApiClient -> выполняет HTTP запросы
          -> возвращает Blob
          -> вызывает downloadBlob
```

## Порядок реализации

1. **Создать useExport hook**
   - Реализовать методы экспорта с обработкой ошибок
   - Добавить логику определения доступных документов

2. **Добавить состояние экспорта в App.tsx**
   - Состояние для управления диалогом
   - Контекст для передачи в ExportDialog

3. **Интегрировать ExportDialog в App.tsx**
   - Добавить компонент в рендер
   - Подключить обработчики и состояние

4. **Обновить FileExplorer**
   - Заменить прямой вызов экспорта на открытие диалога
   - Передать контекст сессии

5. **Добавить экспорт в DocumentHeader**
   - Использовать существующую кнопку onExport
   - Передать контекст текущего документа

6. **Обновить App.tsx для использования DocumentHeader**
   - Добавить DocumentHeader при отображении файла
   - Подключить обработчик экспорта

## Критичные граничные случаи

1. **Отсутствие документов для экспорта**
   - Диалог должен показывать сообщение о том, что нет доступных документов
   - Кнопка экспорта должна быть неактивна

2. **Ошибка при экспорте**
   - Показать уведомление об ошибке пользователю
   - Не закрывать диалог автоматически, чтобы пользователь мог повторить

3. **Большие файлы**
   - Показывать индикатор загрузки во время экспорта
   - Блокировать повторные нажатия во время процесса